---
import Layout from '../layouts/base.astro'
import { getEnv } from '../lib/env'

const { SITE_URL } = Astro.locals
const channel = Astro.props.channel

// è·å–ç¯å¢ƒå˜é‡
const GITHUB_OWNER = getEnv(import.meta.env, Astro, 'GITHUB_OWNER') || 'mkafw'
const GITHUB_REPO = getEnv(import.meta.env, Astro, 'GITHUB_REPO') || 'BroadcastChannel'
const GITHUB_TOKEN = getEnv(import.meta.env, Astro, 'GITHUB_TOKEN')

// RSS è®¢é˜…æºæ•°æ®ï¼ˆå¯ä»¥ä» GitHub Issues è¯»å–ï¼‰
let subscriptions = []

try {
  if (GITHUB_TOKEN) {
    const response = await fetch(
      `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/issues?labels=rss-subscription&state=open`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    )
    
    if (response.ok) {
      const issues = await response.json()
      subscriptions = issues.map(issue => {
        try {
          const body = JSON.parse(issue.body)
          return {
            id: issue.number,
            title: body.title || issue.title,
            url: body.url,
            feedUrl: body.feedUrl,
            description: body.description || '',
            category: body.category || 'æœªåˆ†ç±»',
            lastUpdated: body.lastUpdated,
            issueUrl: issue.html_url
          }
        } catch (e) {
          return null
        }
      }).filter(Boolean)
    }
  }
} catch (error) {
  console.error('Failed to fetch subscriptions:', error)
}

// åˆ†ç±»ç»Ÿè®¡
const categories = subscriptions.reduce((acc, sub) => {
  acc[sub.category] = (acc[sub.category] || 0) + 1
  return acc
}, {})
---

<Layout channel={channel}>
  <div class="rss-subscriptions-page">
    <div class="page-header">
      <h1 class="page-title">ğŸ“¡ RSS è®¢é˜…ç®¡ç†</h1>
      <p class="page-description">è®¢é˜…å…¶ä»–åšå®¢çš„ RSS æºï¼Œéšæ—¶è·å–æœ€æ–°æ–‡ç« </p>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-number">{subscriptions.length}</span>
        <span class="stat-label">è®¢é˜…æº</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{Object.keys(categories).length}</span>
        <span class="stat-label">åˆ†ç±»</span>
      </div>
    </div>

    <div class="actions-bar">
      <a 
        href={`https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/issues/new?labels=rss-subscription&template=rss-subscription.md`}
        class="btn btn-primary"
        target="_blank"
        rel="noopener"
      >
        <span class="btn-icon">â•</span>
        æ·»åŠ è®¢é˜…
      </a>
      <button class="btn btn-secondary" onclick="exportOPML()">
        <span class="btn-icon">ğŸ“¥</span>
        å¯¼å‡º OPML
      </button>
      <button class="btn btn-secondary" onclick="document.getElementById('opml-import').click()">
        <span class="btn-icon">ğŸ“¤</span>
        å¯¼å…¥ OPML
      </button>
      <input 
        type="file" 
        id="opml-import" 
        accept=".opml,.xml" 
        style="display: none;"
        onchange="importOPML(this)"
      />
    </div>

    <div class="subscriptions-container">
      {subscriptions.length === 0 ? (
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <h3>æš‚æ— è®¢é˜…</h3>
          <p>ç‚¹å‡»"æ·»åŠ è®¢é˜…"æŒ‰é’®ï¼Œå¼€å§‹è®¢é˜…ä½ å–œæ¬¢çš„åšå®¢</p>
          <div class="empty-hint">
            <p>ğŸ’¡ æç¤ºï¼šè®¢é˜…ä¼šé€šè¿‡ GitHub Issues å­˜å‚¨</p>
          </div>
        </div>
      ) : (
        <div class="subscriptions-list">
          {Object.entries(
            subscriptions.reduce((acc, sub) => {
              if (!acc[sub.category]) acc[sub.category] = []
              acc[sub.category].push(sub)
              return acc
            }, {})
          ).map(([category, items]) => (
            <div class="category-section">
              <h2 class="category-title">
                <span class="category-icon">ğŸ“</span>
                {category}
                <span class="category-count">({items.length})</span>
              </h2>
              <div class="category-items">
                {items.map(sub => (
                  <div class="subscription-card" data-id={sub.id}>
                    <div class="card-header">
                      <h3 class="card-title">
                        <a href={sub.url} target="_blank" rel="noopener">
                          {sub.title}
                        </a>
                      </h3>
                      <div class="card-actions">
                        <a 
                          href={sub.feedUrl} 
                          class="action-btn feed-btn"
                          title="RSS Feed"
                          target="_blank"
                          rel="noopener"
                        >
                          <span class="action-icon">ğŸ“¶</span>
                        </a>
                        <a 
                          href={sub.issueUrl}
                          class="action-btn edit-btn"
                          title="ç¼–è¾‘"
                          target="_blank"
                          rel="noopener"
                        >
                          <span class="action-icon">âœï¸</span>
                        </a>
                      </div>
                    </div>
                    <p class="card-description">{sub.description}</p>
                    <div class="card-meta">
                      <span class="meta-item">
                        <span class="meta-icon">ğŸ”—</span>
                        <a href={sub.url} target="_blank" rel="noopener">
                          {new URL(sub.url).hostname}
                        </a>
                      </span>
                      {sub.lastUpdated && (
                        <span class="meta-item">
                          <span class="meta-icon">ğŸ•</span>
                          æ›´æ–°äº {new Date(sub.lastUpdated).toLocaleDateString('zh-CN')}
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>

    <div class="help-section">
      <h3>ğŸ“ ä½¿ç”¨è¯´æ˜</h3>
      <div class="help-content">
        <div class="help-item">
          <h4>å¦‚ä½•æ·»åŠ è®¢é˜…ï¼Ÿ</h4>
          <p>ç‚¹å‡»"æ·»åŠ è®¢é˜…"æŒ‰é’®ï¼Œä¼šè·³è½¬åˆ° GitHub Issues é¡µé¢ã€‚æŒ‰ç…§æ¨¡æ¿å¡«å†™ RSS æºä¿¡æ¯å³å¯ã€‚</p>
        </div>
        <div class="help-item">
          <h4>è®¢é˜…æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ</h4>
          <p>æ‰€æœ‰è®¢é˜…æ•°æ®éƒ½å­˜å‚¨åœ¨ GitHub Issues ä¸­ï¼Œæ ‡ç­¾ä¸º <code>rss-subscription</code>ã€‚</p>
        </div>
        <div class="help-item">
          <h4>ä»€ä¹ˆæ˜¯ OPMLï¼Ÿ</h4>
          <p>OPML æ˜¯ RSS è®¢é˜…åˆ—è¡¨çš„æ ‡å‡†æ ¼å¼ã€‚ä½ å¯ä»¥å¯¼å‡º OPML æ–‡ä»¶å¤‡ä»½ï¼Œæˆ–ä»å…¶ä»–é˜…è¯»å™¨å¯¼å…¥ã€‚</p>
        </div>
        <div class="help-item">
          <h4>æœ¬åšå®¢çš„ RSS åœ°å€</h4>
          <code class="rss-url">{SITE_URL}rss.xml</code>
          <button class="copy-btn" onclick="copyRSSUrl()">å¤åˆ¶</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline>
  // å¯¼å‡º OPML
  function exportOPML() {
    const subscriptions = Array.from(document.querySelectorAll('.subscription-card')).map(card => {
      return {
        title: card.querySelector('.card-title a').textContent,
        xmlUrl: card.querySelector('.feed-btn').href,
        htmlUrl: card.querySelector('.card-title a').href,
        category: card.closest('.category-section').querySelector('.category-title').textContent.replace('ğŸ“', '').trim()
      }
    })

    const opml = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
  <head>
    <title>æˆ‘çš„ RSS è®¢é˜…</title>
    <dateCreated>${new Date().toUTCString()}</dateCreated>
  </head>
  <body>
${subscriptions.map(sub => `    <outline type="rss" text="${sub.title}" title="${sub.title}" xmlUrl="${sub.xmlUrl}" htmlUrl="${sub.htmlUrl}" category="${sub.category}"/>`).join('\n')}
  </body>
</opml>`

    const blob = new Blob([opml], { type: 'application/xml' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `rss-subscriptions-${new Date().toISOString().split('T')[0]}.opml`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  // å¯¼å…¥ OPML
  function importOPML(input) {
    const file = input.files[0]
    if (!file) return

    const reader = new FileReader()
    reader.onload = function(e) {
      const content = e.target.result
      alert('OPML æ–‡ä»¶å·²è¯»å–ï¼Œè¯·åœ¨æ–°æ‰“å¼€çš„é¡µé¢ä¸­æ‰‹åŠ¨æ·»åŠ è®¢é˜…ã€‚')
      // è¿™é‡Œå¯ä»¥è§£æ OPML å¹¶å¼•å¯¼ç”¨æˆ·æ‰¹é‡æ·»åŠ 
      console.log('OPML content:', content)
    }
    reader.readAsText(file)
  }

  // å¤åˆ¶ RSS URL
  function copyRSSUrl() {
    const url = document.querySelector('.rss-url').textContent
    navigator.clipboard.writeText(url).then(() => {
      alert('RSS åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')
    })
  }
</script>

<style>
  .rss-subscriptions-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  .page-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .page-title {
    font-size: 2rem;
    color: var(--text-light);
    margin-bottom: 10px;
  }

  .page-description {
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  .stats-bar {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 12px;
    border: 1px solid rgba(139, 92, 246, 0.2);
  }

  .stat-item {
    text-align: center;
  }

  .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #c9a227;
  }

  .stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .actions-bar {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 40px;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #c9a227);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
  }

  .btn-secondary {
    background: rgba(139, 92, 246, 0.2);
    color: var(--text-primary);
    border: 1px solid rgba(139, 92, 246, 0.3);
  }

  .btn-secondary:hover {
    background: rgba(139, 92, 246, 0.3);
  }

  .btn-icon {
    font-size: 1.2rem;
  }

  .subscriptions-container {
    margin-bottom: 40px;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: rgba(26, 22, 46, 0.4);
    border-radius: 16px;
    border: 1px dashed rgba(139, 92, 246, 0.3);
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
  }

  .empty-state h3 {
    color: var(--text-light);
    margin-bottom: 10px;
  }

  .empty-state p {
    color: var(--text-secondary);
    margin-bottom: 20px;
  }

  .empty-hint {
    padding: 15px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 8px;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .category-section {
    margin-bottom: 30px;
  }

  .category-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.3rem;
    color: var(--text-light);
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(139, 92, 246, 0.2);
  }

  .category-icon {
    font-size: 1.2rem;
  }

  .category-count {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: normal;
  }

  .category-items {
    display: grid;
    gap: 15px;
  }

  .subscription-card {
    background: rgba(26, 22, 46, 0.5);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
  }

  .subscription-card:hover {
    border-color: rgba(139, 92, 246, 0.4);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
  }

  .card-title {
    font-size: 1.1rem;
    margin: 0;
  }

  .card-title a {
    color: var(--text-light);
    text-decoration: none;
  }

  .card-title a:hover {
    color: #c9a227;
  }

  .card-actions {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: rgba(139, 92, 246, 0.2);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .action-btn:hover {
    background: rgba(139, 92, 246, 0.4);
    transform: scale(1.1);
  }

  .card-description {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin: 0 0 12px 0;
    line-height: 1.5;
  }

  .card-meta {
    display: flex;
    gap: 20px;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .meta-item a {
    color: #a090c0;
    text-decoration: none;
  }

  .meta-item a:hover {
    color: #c9a227;
  }

  .help-section {
    background: rgba(26, 22, 46, 0.4);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    padding: 25px;
  }

  .help-section h3 {
    color: var(--text-light);
    margin-bottom: 20px;
    font-size: 1.2rem;
  }

  .help-content {
    display: grid;
    gap: 20px;
  }

  .help-item h4 {
    color: #c9a227;
    margin-bottom: 8px;
    font-size: 1rem;
  }

  .help-item p {
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.6;
  }

  .help-item code {
    background: rgba(139, 92, 246, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9rem;
  }

  .rss-url {
    display: inline-block;
    background: rgba(15, 12, 30, 0.8);
    padding: 10px 15px;
    border-radius: 6px;
    margin-right: 10px;
    font-family: monospace;
    font-size: 0.9rem;
    color: #c9a227;
  }

  .copy-btn {
    padding: 8px 16px;
    background: rgba(139, 92, 246, 0.3);
    border: 1px solid rgba(139, 92, 246, 0.4);
    border-radius: 6px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .copy-btn:hover {
    background: rgba(139, 92, 246, 0.5);
  }

  @media (max-width: 768px) {
    .stats-bar {
      gap: 20px;
    }

    .actions-bar {
      flex-direction: column;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }

    .card-header {
      flex-direction: column;
      gap: 10px;
    }

    .card-meta {
      flex-direction: column;
      gap: 8px;
    }
  }
</style>
