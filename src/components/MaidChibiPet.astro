---
// å¤§å·å¥³ä»†æ¡Œå®  - å¸¦ä¾§è¾¹èŠå¤©å¯¹è¯æ¡†
// ç‰¹ç‚¹ï¼šå¤§å¤´åƒã€å¯¹è¯æ¡†åœ¨å·¦ä¾§ã€ç²‰è‰²å¥³ä»†è£…ä¸»é¢˜

interface Props {
  channel?: any
  currentPost?: any
  allPosts?: any[]
}

const { channel, currentPost, allPosts = [] } = Astro.props

// å‡†å¤‡æ–‡ç« æ•°æ®ä¾›AIä½¿ç”¨
const postsData = allPosts.slice(0, 20).map(p => ({
  id: p.id,
  title: p.title,
  content: p.content?.substring(0, 200) || '',
  tags: p.tags || []
}))
---

<!-- å¤§å·å¥³ä»†æ¡Œå®  -->
<div id="maid-pet-container" data-posts={JSON.stringify(postsData)} data-current={JSON.stringify(currentPost)} data-channel={JSON.stringify(channel)}>
  <!-- èŠå¤©å¯¹è¯æ¡†ï¼ˆåœ¨å·¦ä¾§ï¼‰ -->
  <div id="maid-chat" class="maid-chat-window">
    <div class="chat-header">
      <span class="maid-icon">ğŸ€</span>
      <span class="maid-title">å°å¥³ä»†åŠ©æ‰‹</span>
      <button class="close-btn" onclick="toggleMaidChat()">Ã—</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="message maid-message">
        <div class="message-avatar">ğŸ€</div>
        <div class="message-content">
          ä¸»äººå¥½~ æˆ‘æ˜¯æ‚¨çš„å°å¥³ä»†åŠ©æ‰‹ï¼ğŸ’•<br>
          æˆ‘å¯ä»¥å¸®æ‚¨ï¼š<br>
          â€¢ è¾“å…¥"æ€»ç»“" - æ€»ç»“å½“å‰æ–‡ç« <br>
          â€¢ è¾“å…¥"æ¨è" - æ¨èç›¸å…³æ–‡ç« <br>
          â€¢ è¾“å…¥"æœç´¢+å…³é”®è¯" - æœç´¢æ–‡ç« <br>
          â€¢ ç›´æ¥èŠå¤© - è·Ÿæˆ‘é—²èŠ~ âœ¨
        </div>
      </div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="è·Ÿå°å¥³ä»†è¯´ç‚¹ä»€ä¹ˆ..." />
      <button id="send-btn" onclick="sendMaidMessage()">å‘é€</button>
    </div>
  </div>
  
  <!-- å¥³ä»†å¤´åƒï¼ˆåœ¨å³ä¾§ï¼‰ -->
  <div id="maid-avatar" class="maid-avatar-large" onclick="toggleMaidChat()">
    <!-- å¤´å‘ï¼ˆåŒé©¬å°¾ï¼‰ -->
    <div class="maid-hair-left"></div>
    <div class="maid-hair-right"></div>
    
    <!-- å¥³ä»†å¤´é¥° -->
    <div class="maid-headband">
      <div class="ribbon-left">ğŸ€</div>
      <div class="ribbon-right">ğŸ€</div>
    </div>
    
    <!-- å¤§è„¸ -->
    <div class="maid-face">
      <!-- å¤§çœ¼ç›ï¼ˆé•¿ç«æ¯›ï¼‰ -->
      <div class="maid-eye left">
        <div class="eye-lash"></div>
        <div class="eye-shine"></div>
      </div>
      <div class="maid-eye right">
        <div class="eye-lash"></div>
        <div class="eye-shine"></div>
      </div>
      
      <!-- è…®çº¢ -->
      <div class="maid-blush left"></div>
      <div class="maid-blush right"></div>
      
      <!-- å°å˜´å·´ -->
      <div class="maid-mouth">â—¡</div>
    </div>
    
    <!-- å¥³ä»†è£…é¢†å­ -->
    <div class="maid-collar">
      <div class="collar-frill"></div>
    </div>
    
    <!-- å›´è£™ -->
    <div class="maid-apron">
      <div class="apron-pocket"></div>
    </div>
    
    <!-- æ‚¬æµ®è£…é¥° -->
    <div class="floating-hearts">
      <span class="heart">ğŸ’•</span>
      <span class="heart">ğŸŒ¸</span>
      <span class="heart">âœ¨</span>
    </div>
    
    <!-- ç‚¹å‡»æç¤º -->
    <div class="click-hint">ğŸ’¬</div>
  </div>
</div>

<style>
  /* å¥³ä»†æ¡Œå® å®¹å™¨ */
  #maid-pet-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    align-items: flex-end;
    gap: 15px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
  }
  
  /* èŠå¤©çª—å£ - åœ¨å·¦ä¾§ */
  .maid-chat-window {
    width: 300px;
    max-height: 400px;
    background: linear-gradient(135deg, rgba(255, 182, 193, 0.95), rgba(255, 218, 225, 0.95));
    border-radius: 20px;
    border: 2px solid rgba(255, 255, 255, 0.6);
    box-shadow: 
      0 10px 40px rgba(255, 105, 180, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.5);
    display: none;
    flex-direction: column;
    overflow: hidden;
    backdrop-filter: blur(10px);
    animation: popIn 0.3s ease;
  }
  
  .maid-chat-window.active {
    display: flex;
  }
  
  @keyframes popIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateX(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateX(0);
    }
  }
  
  /* èŠå¤©å¤´éƒ¨ */
  .chat-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .maid-icon {
    font-size: 20px;
    margin-right: 8px;
  }
  
  .maid-title {
    flex: 1;
    font-weight: 600;
    font-size: 14px;
  }
  
  .close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  
  .close-btn:hover {
    background: rgba(255, 255, 255, 0.4);
  }
  
  /* æ¶ˆæ¯åŒºåŸŸ */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    max-height: 250px;
  }
  
  .message {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
    animation: messageSlide 0.3s ease;
  }
  
  @keyframes messageSlide {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .message-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  
  .message-content {
    background: rgba(255, 255, 255, 0.9);
    padding: 10px 14px;
    border-radius: 15px;
    border-bottom-left-radius: 4px;
    font-size: 13px;
    line-height: 1.5;
    color: #333;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .user-message .message-content {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 4px;
  }
  
  .user-message {
    flex-direction: row-reverse;
  }
  
  /* è¾“å…¥åŒºåŸŸ */
  .chat-input-area {
    display: flex;
    gap: 8px;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.5);
    border-top: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  #chat-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid rgba(255, 105, 180, 0.3);
    border-radius: 20px;
    font-size: 13px;
    outline: none;
    background: rgba(255, 255, 255, 0.9);
  }
  
  #chat-input:focus {
    border-color: #ff69b4;
    box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
  }
  
  #send-btn {
    padding: 10px 18px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  #send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
  }
  
  /* å¤§å·å¥³ä»†å¤´åƒ */
  .maid-avatar-large {
    width: 140px;
    height: 180px;
    position: relative;
    cursor: pointer;
    animation: maidFloat 3s ease-in-out infinite;
    filter: drop-shadow(0 10px 20px rgba(255, 105, 180, 0.3));
  }
  
  @keyframes maidFloat {
    0%, 100% {
      transform: translateY(0) rotate(0deg);
    }
    25% {
      transform: translateY(-8px) rotate(-1deg);
    }
    75% {
      transform: translateY(-5px) rotate(1deg);
    }
  }
  
  /* å¤´å‘ */
  .maid-hair-left,
  .maid-hair-right {
    position: absolute;
    width: 45px;
    height: 80px;
    background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
    border-radius: 50%;
    top: 20px;
  }
  
  .maid-hair-left {
    left: 5px;
    transform: rotate(-15deg);
  }
  
  .maid-hair-right {
    right: 5px;
    transform: rotate(15deg);
  }
  
  /* å¤´é¥° */
  .maid-headband {
    position: absolute;
    top: 25px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 25px;
    background: linear-gradient(180deg, #fff 0%, #f0f0f0 100%);
    border-radius: 12px;
    border: 2px solid #ff69b4;
    z-index: 10;
  }
  
  .ribbon-left,
  .ribbon-right {
    position: absolute;
    top: -5px;
    font-size: 24px;
    animation: ribbonBounce 2s ease-in-out infinite;
  }
  
  .ribbon-left {
    left: -10px;
  }
  
  .ribbon-right {
    right: -10px;
    animation-delay: 0.5s;
  }
  
  @keyframes ribbonBounce {
    0%, 100% {
      transform: scale(1) rotate(-5deg);
    }
    50% {
      transform: scale(1.1) rotate(5deg);
    }
  }
  
  /* å¤§è„¸ */
  .maid-face {
    position: absolute;
    top: 35px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 90px;
    background: linear-gradient(180deg, #ffe4e1 0%, #ffdab9 100%);
    border-radius: 50%;
    z-index: 5;
    box-shadow: 
      inset 0 -5px 15px rgba(255, 182, 193, 0.3),
      0 5px 15px rgba(0, 0, 0, 0.1);
  }
  
  /* å¤§çœ¼ç› */
  .maid-eye {
    position: absolute;
    top: 30px;
    width: 28px;
    height: 32px;
    background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%);
    border-radius: 50%;
    border: 2px solid #333;
    overflow: hidden;
  }
  
  .maid-eye.left {
    left: 12px;
  }
  
  .maid-eye.right {
    right: 12px;
  }
  
  .eye-lash {
    position: absolute;
    top: -3px;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 8px;
    background: #333;
    border-radius: 50%;
  }
  
  .eye-shine {
    position: absolute;
    top: 6px;
    right: 4px;
    width: 10px;
    height: 10px;
    background: radial-gradient(circle, #fff 0%, transparent 70%);
    border-radius: 50%;
  }
  
  .maid-eye::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 18px;
    height: 22px;
    background: linear-gradient(180deg, #4a4a4a 0%, #2a2a2a 100%);
    border-radius: 50%;
  }
  
  /* è…®çº¢ */
  .maid-blush {
    position: absolute;
    top: 55px;
    width: 20px;
    height: 12px;
    background: radial-gradient(ellipse, rgba(255, 105, 180, 0.4) 0%, transparent 70%);
    border-radius: 50%;
  }
  
  .maid-blush.left {
    left: 5px;
  }
  
  .maid-blush.right {
    right: 5px;
  }
  
  /* å°å˜´å·´ */
  .maid-mouth {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 18px;
    color: #ff69b4;
  }
  
  /* é¢†å­ */
  .maid-collar {
    position: absolute;
    top: 115px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 25px;
    background: #fff;
    border-radius: 0 0 40px 40px;
    border: 2px solid #e0e0e0;
    z-index: 4;
  }
  
  .collar-frill {
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 15px;
    background: repeating-linear-gradient(
      90deg,
      #fff 0px,
      #fff 8px,
      #ff69b4 8px,
      #ff69b4 10px
    );
    border-radius: 10px;
  }
  
  /* å›´è£™ */
  .maid-apron {
    position: absolute;
    top: 130px;
    left: 50%;
    transform: translateX(-50%);
    width: 70px;
    height: 50px;
    background: linear-gradient(180deg, #fff 0%, #f8f8f8 100%);
    border-radius: 10px 10px 25px 25px;
    border: 2px solid #e0e0e0;
    z-index: 3;
  }
  
  .apron-pocket {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 35px;
    height: 20px;
    background: #f0f0f0;
    border-radius: 0 0 15px 15px;
    border: 1px solid #e0e0e0;
  }
  
  /* æ‚¬æµ®è£…é¥° */
  .floating-hearts {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }
  
  .floating-hearts .heart {
    position: absolute;
    font-size: 20px;
    opacity: 0;
    animation: heartFloat 3s ease-in-out infinite;
  }
  
  .floating-hearts .heart:nth-child(1) {
    left: -10px;
    top: 50%;
    animation-delay: 0s;
  }
  
  .floating-hearts .heart:nth-child(2) {
    right: -10px;
    top: 40%;
    animation-delay: 1s;
  }
  
  .floating-hearts .heart:nth-child(3) {
    left: 50%;
    top: -10px;
    animation-delay: 2s;
  }
  
  @keyframes heartFloat {
    0% {
      opacity: 0;
      transform: translateY(0) scale(0.5);
    }
    20% {
      opacity: 1;
      transform: translateY(-10px) scale(1);
    }
    80% {
      opacity: 1;
    }
    100% {
      opacity: 0;
      transform: translateY(-40px) scale(0.5);
    }
  }
  
  /* ç‚¹å‡»æç¤º */
  .click-hint {
    position: absolute;
    top: -10px;
    right: -5px;
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    animation: hintPulse 2s ease-in-out infinite;
    border: 2px solid white;
    box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
  }
  
  @keyframes hintPulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
  }
  
  /* èŠå¤©çª—å£æ‰“å¼€æ—¶éšè—æç¤º */
  .maid-chat-window.active ~ .maid-avatar-large .click-hint {
    display: none;
  }
  
  /* å“åº”å¼ */
  @media (max-width: 768px) {
    #maid-pet-container {
      bottom: 10px;
      right: 10px;
    }
    
    .maid-avatar-large {
      width: 100px;
      height: 130px;
    }
    
    .maid-chat-window {
      width: 260px;
      position: fixed;
      bottom: 150px;
      right: 10px;
    }
  }
</style>

<script is:inline>
  // å¥³ä»†æ¡Œå® èŠå¤©åŠŸèƒ½
  let chatOpen = false;
  let currentPost = null;
  let allPosts = [];
  
  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('maid-pet-container');
    if (container) {
      const postsData = container.dataset.posts;
      const currentData = container.dataset.current;
      
      if (postsData) {
        try {
          allPosts = JSON.parse(postsData);
        } catch (e) {
          console.log('Failed to parse posts data');
        }
      }
      
      if (currentData && currentData !== 'null') {
        try {
          currentPost = JSON.parse(currentData);
        } catch (e) {
          console.log('Failed to parse current post data');
        }
      }
    }
    
    // ç»‘å®šå›è½¦é”®
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMaidMessage();
        }
      });
    }
  });
  
  // åˆ‡æ¢èŠå¤©çª—å£
  function toggleMaidChat() {
    const chatWindow = document.getElementById('maid-chat');
    chatOpen = !chatOpen;
    
    if (chatOpen) {
      chatWindow.classList.add('active');
      document.getElementById('chat-input').focus();
    } else {
      chatWindow.classList.remove('active');
    }
  }
  
  // å‘é€æ¶ˆæ¯
  function sendMaidMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage(message, 'user');
    input.value = '';
    
    // å¤„ç†å‘½ä»¤
    processCommand(message);
  }
  
  // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
  function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (sender === 'user') {
      messageDiv.innerHTML = `
        <div class="message-content">${escapeHtml(text)}</div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="message-avatar">ğŸ€</div>
        <div class="message-content">${text}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  // å¤„ç†å‘½ä»¤
  function processCommand(message) {
    const lowerMsg = message.toLowerCase();
    
    // å»¶è¿Ÿå›å¤ï¼Œæ¨¡æ‹Ÿæ€è€ƒ
    setTimeout(() => {
      if (lowerMsg.includes('æ€»ç»“') || lowerMsg.includes('summarize')) {
        handleSummarize();
      } else if (lowerMsg.includes('æ¨è') || lowerMsg.includes('recommend')) {
        handleRecommend();
      } else if (lowerMsg.startsWith('æœç´¢') || lowerMsg.startsWith('search')) {
        const keyword = message.replace(/^(æœç´¢|search)\s*/i, '');
        handleSearch(keyword);
      } else if (lowerMsg.includes('ä½ å¥½') || lowerMsg.includes('hi') || lowerMsg.includes('hello')) {
        addMessage('ä¸»äººå¥½~ å°å¥³ä»†ä¸ºæ‚¨æœåŠ¡ï¼ğŸ’• æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ', 'maid');
      } else if (lowerMsg.includes('å¯çˆ±') || lowerMsg.includes('æ¼‚äº®')) {
        addMessage('å“å‘€ï¼Œä¸»äººè¿‡å¥–äº†~ äººå®¶ä¼šå®³ç¾çš„~ ğŸ€âœ¨', 'maid');
      } else {
        // é€šç”¨å›å¤
        const replies = [
          'å—¯å—¯ï¼Œå°å¥³ä»†æ˜ç™½å•¦~ ğŸ’•',
          'ä¸»äººè¯´å¾—å¯¹å‘¢ï¼âœ¨',
          'å°å¥³ä»†è®°ä½äº†~ ğŸ€',
          'å¥½çš„å‘¢ï¼Œä¸»äºº~ ğŸ’•',
          'æ”¶åˆ°ï¼å°å¥³ä»†ä¼šåŠªåŠ›çš„~ âœ¨'
        ];
        const randomReply = replies[Math.floor(Math.random() * replies.length)];
        addMessage(randomReply, 'maid');
      }
    }, 500 + Math.random() * 500);
  }
  
  // æ€»ç»“æ–‡ç« 
  function handleSummarize() {
    if (!currentPost) {
      addMessage('ä¸»äººï¼Œå½“å‰æ²¡æœ‰æ­£åœ¨é˜…è¯»çš„æ–‡ç« å‘¢~ è¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘å°±å¯ä»¥å¸®æ‚¨æ€»ç»“å•¦ï¼ğŸ’•', 'maid');
      return;
    }
    
    const title = currentPost.title || 'è¿™ç¯‡æ–‡ç« ';
    const content = currentPost.content || '';
    
    // ç®€å•çš„æœ¬åœ°æ€»ç»“ï¼ˆæå–å‰å‡ å¥ï¼‰
    const sentences = content.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 10);
    const summary = sentences.slice(0, 3).join('ã€‚');
    
    if (summary) {
      addMessage(`ğŸ“ <strong>${title}</strong> çš„æ€»ç»“ï¼š<br><br>${summary}...<br><br>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è¿°äº†ä»¥ä¸Šå†…å®¹~ âœ¨`, 'maid');
    } else {
      addMessage(`ğŸ“ <strong>${title}</strong><br><br>è¿™æ˜¯ä¸€ç¯‡å¾ˆæœ‰è¶£çš„æ–‡ç« å‘¢~ å»ºè®®ä¸»äººä»”ç»†é˜…è¯»å…¨æ–‡å“¦ï¼ğŸ’•`, 'maid');
    }
  }
  
  // æ¨èæ–‡ç« 
  function handleRecommend() {
    if (allPosts.length === 0) {
      addMessage('ä¸»äººï¼Œæš‚æ—¶æ²¡æœ‰æ–‡ç« å¯ä»¥æ¨èå‘¢~ ç¨åå†æ¥å§ï¼ğŸ’•', 'maid');
      return;
    }
    
    // éšæœºé€‰æ‹©3ç¯‡æ–‡ç« 
    const shuffled = [...allPosts].sort(() => 0.5 - Math.random());
    const recommendations = shuffled.slice(0, 3);
    
    let reply = 'ğŸ“š å°å¥³ä»†ä¸ºæ‚¨æ¨èä»¥ä¸‹æ–‡ç« ï¼š<br><br>';
    recommendations.forEach((post, index) => {
      const shortTitle = post.title?.length > 20 ? post.title.substring(0, 20) + '...' : post.title;
      reply += `${index + 1}. <a href="/posts/${post.id}" style="color: #ff1493; text-decoration: underline;">${shortTitle}</a><br>`;
    });
    reply += '<br>ç‚¹å‡»æ ‡é¢˜å³å¯é˜…è¯»å“¦~ ğŸ’•';
    
    addMessage(reply, 'maid');
  }
  
  // æœç´¢æ–‡ç« 
  function handleSearch(keyword) {
    if (!keyword) {
      addMessage('ä¸»äººï¼Œè¯·è¾“å…¥æœç´¢å…³é”®è¯å“¦~ æ¯”å¦‚"æœç´¢ AI" ğŸ’•', 'maid');
      return;
    }
    
    if (allPosts.length === 0) {
      addMessage('ä¸»äººï¼Œæš‚æ—¶æ²¡æœ‰æ–‡ç« å¯ä»¥æœç´¢å‘¢~ ç¨åå†æ¥å§ï¼ğŸ’•', 'maid');
      return;
    }
    
    const results = allPosts.filter(post => {
      const title = post.title || '';
      const content = post.content || '';
      const tags = post.tags || [];
      const searchText = `${title} ${content} ${tags.join(' ')}`.toLowerCase();
      return searchText.includes(keyword.toLowerCase());
    });
    
    if (results.length === 0) {
      addMessage(`ğŸ˜¢ å°å¥³ä»†æ²¡æœ‰æ‰¾åˆ°åŒ…å«"${keyword}"çš„æ–‡ç« å‘¢~ æ¢ä¸ªå…³é”®è¯è¯•è¯•å§ï¼ğŸ’•`, 'maid');
    } else {
      let reply = `ğŸ” æ‰¾åˆ° ${results.length} ç¯‡å…³äº"${keyword}"çš„æ–‡ç« ï¼š<br><br>`;
      results.slice(0, 5).forEach((post, index) => {
        const shortTitle = post.title?.length > 20 ? post.title.substring(0, 20) + '...' : post.title;
        reply += `${index + 1}. <a href="/posts/${post.id}" style="color: #ff1493; text-decoration: underline;">${shortTitle}</a><br>`;
      });
      if (results.length > 5) {
        reply += `<br>...è¿˜æœ‰ ${results.length - 5} ç¯‡ç›¸å…³æ–‡ç« ~ ğŸ’•`;
      }
      addMessage(reply, 'maid');
    }
  }
  
  // HTMLè½¬ä¹‰
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
