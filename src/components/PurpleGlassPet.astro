---
// ç´«è‰²ç»ç’ƒä¸»é¢˜ - å›¾ç‰‡ç‰ˆæ¡Œå® 
// ç‰¹ç‚¹ï¼šä½¿ç”¨å¤é£ç¾å¥³å›¾ç‰‡ + æš—ç´«é‡‘è‰²ç»ç’ƒé£æ ¼ + ä¾§è¾¹èŠå¤©

interface Props {
  channel?: any
  currentPost?: any
  allPosts?: any[]
  avatarUrl?: string
}

const { channel, currentPost, allPosts = [], avatarUrl = '/maid-avatar.png' } = Astro.props

// å‡†å¤‡æ–‡ç« æ•°æ®ä¾›AIä½¿ç”¨
const postsData = allPosts.slice(0, 20).map(p => ({
  id: p.id,
  title: p.title,
  content: p.content?.substring(0, 200) || '',
  tags: p.tags || []
}))
---

<!-- ç´«è‰²ç»ç’ƒä¸»é¢˜æ¡Œå®  -->
<div id="purple-pet-container" data-posts={JSON.stringify(postsData)} data-current={JSON.stringify(currentPost)} data-channel={JSON.stringify(channel)}>
  <!-- èŠå¤©å¯¹è¯æ¡†ï¼ˆåœ¨å·¦ä¾§ï¼‰ -->
  <div id="purple-chat" class="purple-chat-window">
    <div class="purple-chat-header">
      <span class="purple-icon">âœ¨</span>
      <span class="purple-title">ç´«é‡‘åŠ©æ‰‹</span>
      <button class="purple-close-btn" onclick="togglePurpleChat()">Ã—</button>
    </div>
    <div class="purple-chat-messages" id="purple-chat-messages">
      <div class="purple-message assistant-message">
        <div class="purple-message-avatar">
          <img src={avatarUrl} alt="Assistant" />
        </div>
        <div class="purple-message-content">
          æ¬¢è¿æ¥åˆ°ç´«é‡‘åšå®¢~ âœ¨<br>
          æˆ‘å¯ä»¥å¸®æ‚¨ï¼š<br>
          â€¢ è¾“å…¥"æ€»ç»“" - æ€»ç»“å½“å‰æ–‡ç« <br>
          â€¢ è¾“å…¥"æ¨è" - æ¨èç›¸å…³æ–‡ç« <br>
          â€¢ è¾“å…¥"æœç´¢+å…³é”®è¯" - æœç´¢æ–‡ç« <br>
          â€¢ ç›´æ¥èŠå¤© - ä¸æˆ‘äº¤æµ~ ğŸ’œ
        </div>
      </div>
    </div>
    <div class="purple-chat-input-area">
      <input type="text" id="purple-chat-input" placeholder="è·Ÿæˆ‘èŠèŠå§..." />
      <button id="purple-send-btn" onclick="sendPurpleMessage()">
        <span>å‘é€</span>
      </button>
    </div>
  </div>
  
  <!-- æ¡Œå® å¤´åƒï¼ˆåœ¨å³ä¾§ï¼‰ -->
  <div id="purple-avatar" class="purple-avatar-glass" onclick="togglePurpleChat()">
    <div class="purple-avatar-ring"></div>
    <div class="purple-avatar-glow"></div>
    <img src={avatarUrl} alt="ç´«é‡‘åŠ©æ‰‹" class="purple-avatar-img" />
    <div class="purple-avatar-shine"></div>
    
    <!-- æ‚¬æµ®ç²’å­æ•ˆæœ -->
    <div class="purple-particles">
      <span class="particle"></span>
      <span class="particle"></span>
      <span class="particle"></span>
      <span class="particle"></span>
    </div>
    
    <!-- ç‚¹å‡»æç¤º -->
    <div class="purple-click-hint">ğŸ’¬</div>
  </div>
</div>

<style>
  /* ç´«è‰²ç»ç’ƒä¸»é¢˜æ¡Œå® å®¹å™¨ */
  #purple-pet-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 9999;
    display: flex;
    align-items: flex-end;
    gap: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
  }
  
  /* ç»ç’ƒè´¨æ„ŸèŠå¤©çª—å£ - åœ¨å·¦ä¾§ */
  .purple-chat-window {
    width: 320px;
    max-height: 450px;
    background: linear-gradient(135deg, 
      rgba(26, 10, 46, 0.95) 0%, 
      rgba(107, 70, 193, 0.9) 50%,
      rgba(26, 10, 46, 0.95) 100%);
    border-radius: 24px;
    border: 1px solid rgba(212, 175, 55, 0.4);
    box-shadow: 
      0 20px 60px rgba(107, 70, 193, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    display: none;
    flex-direction: column;
    overflow: hidden;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    animation: purplePopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .purple-chat-window.active {
    display: flex;
  }
  
  @keyframes purplePopIn {
    from {
      opacity: 0;
      transform: scale(0.8) translateX(30px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateX(0);
    }
  }
  
  /* èŠå¤©å¤´éƒ¨ - ç´«é‡‘æ¸å˜ */
  .purple-chat-header {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, 
      rgba(107, 70, 193, 0.8) 0%, 
      rgba(212, 175, 55, 0.6) 100%);
    color: #fff;
    border-bottom: 1px solid rgba(212, 175, 55, 0.3);
  }
  
  .purple-icon {
    font-size: 20px;
    margin-right: 10px;
    filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.8));
  }
  
  .purple-title {
    flex: 1;
    font-weight: 600;
    font-size: 15px;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  
  .purple-close-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .purple-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }
  
  /* æ¶ˆæ¯åŒºåŸŸ */
  .purple-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    max-height: 300px;
  }
  
  .purple-message {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    animation: purpleMessageSlide 0.4s ease;
  }
  
  @keyframes purpleMessageSlide {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .purple-message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid rgba(212, 175, 55, 0.5);
    box-shadow: 0 4px 15px rgba(107, 70, 193, 0.4);
    flex-shrink: 0;
  }
  
  .purple-message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .purple-message-content {
    background: rgba(255, 255, 255, 0.1);
    padding: 12px 16px;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    font-size: 14px;
    line-height: 1.6;
    color: #f0f0f0;
    border: 1px solid rgba(212, 175, 55, 0.2);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    max-width: 220px;
  }
  
  .user-message .purple-message-content {
    background: linear-gradient(135deg, rgba(107, 70, 193, 0.8), rgba(212, 175, 55, 0.6));
    color: white;
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 4px;
    border: 1px solid rgba(212, 175, 55, 0.4);
  }
  
  .user-message {
    flex-direction: row-reverse;
  }
  
  /* è¾“å…¥åŒºåŸŸ */
  .purple-chat-input-area {
    display: flex;
    gap: 10px;
    padding: 16px 20px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(212, 175, 55, 0.2);
  }
  
  #purple-chat-input {
    flex: 1;
    padding: 12px 18px;
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 24px;
    font-size: 14px;
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    color: #f0f0f0;
    transition: all 0.3s ease;
  }
  
  #purple-chat-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }
  
  #purple-chat-input:focus {
    border-color: rgba(212, 175, 55, 0.6);
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
    background: rgba(255, 255, 255, 0.12);
  }
  
  #purple-send-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, 
      rgba(107, 70, 193, 0.9) 0%, 
      rgba(212, 175, 55, 0.8) 100%);
    color: white;
    border: none;
    border-radius: 24px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(212, 175, 55, 0.4);
    box-shadow: 0 4px 15px rgba(107, 70, 193, 0.3);
  }
  
  #purple-send-btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
  }
  
  #purple-send-btn:active {
    transform: translateY(0) scale(0.98);
  }
  
  /* ç»ç’ƒè´¨æ„Ÿå¤´åƒ - å¤§ç‰ˆæœ¬ */
  .purple-avatar-glass {
    width: 160px;
    height: 200px;
    position: relative;
    cursor: pointer;
    animation: purpleFloat 4s ease-in-out infinite;
  }
  
  @keyframes purpleFloat {
    0%, 100% {
      transform: translateY(0) rotate(0deg);
    }
    25% {
      transform: translateY(-10px) rotate(-1deg);
    }
    50% {
      transform: translateY(-5px) rotate(0deg);
    }
    75% {
      transform: translateY(-8px) rotate(1deg);
    }
  }
  
  /* å¤–åœˆå…‰ç¯ */
  .purple-avatar-ring {
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border: 2px solid rgba(212, 175, 55, 0.3);
    border-radius: 50%;
    animation: purpleRing 3s linear infinite;
  }
  
  .purple-avatar-ring::before {
    content: '';
    position: absolute;
    top: 5px;
    left: 5px;
    right: 5px;
    bottom: 5px;
    border: 1px solid rgba(107, 70, 193, 0.4);
    border-radius: 50%;
    animation: purpleRing 3s linear infinite reverse;
  }
  
  @keyframes purpleRing {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  
  /* å‘å…‰æ•ˆæœ */
  .purple-avatar-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: 220px;
    background: radial-gradient(ellipse, 
      rgba(107, 70, 193, 0.4) 0%, 
      rgba(212, 175, 55, 0.2) 40%,
      transparent 70%);
    border-radius: 50%;
    filter: blur(20px);
    animation: purpleGlow 4s ease-in-out infinite;
  }
  
  @keyframes purpleGlow {
    0%, 100% {
      opacity: 0.6;
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1);
    }
  }
  
  /* å¤´åƒå›¾ç‰‡ */
  .purple-avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 20px;
    border: 3px solid rgba(212, 175, 55, 0.5);
    box-shadow: 
      0 10px 40px rgba(107, 70, 193, 0.4),
      0 0 0 1px rgba(255, 255, 255, 0.1),
      inset 0 0 20px rgba(212, 175, 55, 0.2);
    position: relative;
    z-index: 10;
    transition: all 0.4s ease;
  }
  
  .purple-avatar-glass:hover .purple-avatar-img {
    transform: scale(1.05);
    box-shadow: 
      0 15px 50px rgba(107, 70, 193, 0.5),
      0 0 0 2px rgba(212, 175, 55, 0.6),
      inset 0 0 30px rgba(212, 175, 55, 0.3);
  }
  
  /* é«˜å…‰æ•ˆæœ */
  .purple-avatar-shine {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    height: 40%;
    background: linear-gradient(180deg, 
      rgba(255, 255, 255, 0.2) 0%,
      transparent 100%);
    border-radius: 16px 16px 0 0;
    pointer-events: none;
    z-index: 11;
  }
  
  /* æ‚¬æµ®ç²’å­ */
  .purple-particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
  }
  
  .particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: radial-gradient(circle, rgba(212, 175, 55, 0.8) 0%, transparent 70%);
    border-radius: 50%;
    animation: purpleParticle 3s ease-in-out infinite;
  }
  
  .particle:nth-child(1) {
    top: -20px;
    left: 20%;
    animation-delay: 0s;
  }
  
  .particle:nth-child(2) {
    top: 30%;
    right: -15px;
    animation-delay: 0.7s;
  }
  
  .particle:nth-child(3) {
    bottom: 20%;
    left: -10px;
    animation-delay: 1.4s;
  }
  
  .particle:nth-child(4) {
    bottom: -15px;
    right: 30%;
    animation-delay: 2.1s;
  }
  
  @keyframes purpleParticle {
    0%, 100% {
      opacity: 0;
      transform: translateY(0) scale(0.5);
    }
    50% {
      opacity: 1;
      transform: translateY(-30px) scale(1);
    }
  }
  
  /* ç‚¹å‡»æç¤º */
  .purple-click-hint {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, 
      rgba(107, 70, 193, 0.9), 
      rgba(212, 175, 55, 0.9));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    animation: purpleHintPulse 2s ease-in-out infinite;
    border: 2px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 4px 20px rgba(107, 70, 193, 0.5);
    z-index: 20;
  }
  
  @keyframes purpleHintPulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 4px 20px rgba(107, 70, 193, 0.5);
    }
    50% {
      transform: scale(1.15);
      box-shadow: 0 6px 30px rgba(212, 175, 55, 0.6);
    }
  }
  
  /* èŠå¤©çª—å£æ‰“å¼€æ—¶éšè—æç¤º */
  .purple-chat-window.active ~ .purple-avatar-glass .purple-click-hint {
    display: none;
  }
  
  /* æ»šåŠ¨æ¡æ ·å¼ */
  .purple-chat-messages::-webkit-scrollbar {
    width: 6px;
  }
  
  .purple-chat-messages::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }
  
  .purple-chat-messages::-webkit-scrollbar-thumb {
    background: rgba(212, 175, 55, 0.4);
    border-radius: 3px;
  }
  
  .purple-chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(212, 175, 55, 0.6);
  }
  
  /* å“åº”å¼ */
  @media (max-width: 768px) {
    #purple-pet-container {
      bottom: 15px;
      right: 15px;
    }
    
    .purple-avatar-glass {
      width: 120px;
      height: 150px;
    }
    
    .purple-chat-window {
      width: 280px;
      position: fixed;
      bottom: 170px;
      right: 15px;
    }
  }
</style>

<script is:inline>
  // ç´«è‰²ç»ç’ƒä¸»é¢˜æ¡Œå® åŠŸèƒ½
  let purpleChatOpen = false;
  let purpleCurrentPost = null;
  let purpleAllPosts = [];
  
  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('purple-pet-container');
    if (container) {
      const postsData = container.dataset.posts;
      const currentData = container.dataset.current;
      
      if (postsData) {
        try {
          purpleAllPosts = JSON.parse(postsData);
        } catch (e) {
          console.log('Failed to parse posts data');
        }
      }
      
      if (currentData && currentData !== 'null') {
        try {
          purpleCurrentPost = JSON.parse(currentData);
        } catch (e) {
          console.log('Failed to parse current post data');
        }
      }
    }
    
    // ç»‘å®šå›è½¦é”®
    const chatInput = document.getElementById('purple-chat-input');
    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendPurpleMessage();
        }
      });
    }
  });
  
  // åˆ‡æ¢èŠå¤©çª—å£
  function togglePurpleChat() {
    const chatWindow = document.getElementById('purple-chat');
    purpleChatOpen = !purpleChatOpen;
    
    if (purpleChatOpen) {
      chatWindow.classList.add('active');
      document.getElementById('purple-chat-input').focus();
    } else {
      chatWindow.classList.remove('active');
    }
  }
  
  // å‘é€æ¶ˆæ¯
  function sendPurpleMessage() {
    const input = document.getElementById('purple-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addPurpleMessage(message, 'user');
    input.value = '';
    
    // å¤„ç†å‘½ä»¤
    processPurpleCommand(message);
  }
  
  // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
  function addPurpleMessage(text, sender) {
    const messagesContainer = document.getElementById('purple-chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `purple-message ${sender}-message`;
    
    if (sender === 'user') {
      messageDiv.innerHTML = `
        <div class="purple-message-content">${escapePurpleHtml(text)}</div>
      `;
    } else {
      const avatarUrl = document.querySelector('.purple-avatar-img')?.src || '/maid-avatar.png';
      messageDiv.innerHTML = `
        <div class="purple-message-avatar">
          <img src="${avatarUrl}" alt="Assistant" />
        </div>
        <div class="purple-message-content">${text}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  // å¤„ç†å‘½ä»¤
  function processPurpleCommand(message) {
    const lowerMsg = message.toLowerCase();
    
    // å»¶è¿Ÿå›å¤ï¼Œæ¨¡æ‹Ÿæ€è€ƒ
    setTimeout(() => {
      if (lowerMsg.includes('æ€»ç»“') || lowerMsg.includes('summarize')) {
        handlePurpleSummarize();
      } else if (lowerMsg.includes('æ¨è') || lowerMsg.includes('recommend')) {
        handlePurpleRecommend();
      } else if (lowerMsg.startsWith('æœç´¢') || lowerMsg.startsWith('search')) {
        const keyword = message.replace(/^(æœç´¢|search)\s*/i, '');
        handlePurpleSearch(keyword);
      } else if (lowerMsg.includes('ä½ å¥½') || lowerMsg.includes('hi') || lowerMsg.includes('hello')) {
        addPurpleMessage('ä¸»äººå¥½~ æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿâœ¨', 'assistant');
      } else if (lowerMsg.includes('åå­—')) {
        addPurpleMessage('æˆ‘æ˜¯æ‚¨çš„ç´«é‡‘åŠ©æ‰‹~ ğŸ’œ', 'assistant');
      } else {
        // é€šç”¨å›å¤
        const replies = [
          'æ˜ç™½äº†~ âœ¨',
          'æ”¶åˆ°ï¼ğŸ’œ',
          'å¥½çš„å‘¢~ ğŸŒŸ',
          'äº†è§£äº†ï¼âœ¨',
          'éµå‘½~ ğŸ’œ'
        ];
        const randomReply = replies[Math.floor(Math.random() * replies.length)];
        addPurpleMessage(randomReply, 'assistant');
      }
    }, 600 + Math.random() * 400);
  }
  
  // æ€»ç»“æ–‡ç« 
  function handlePurpleSummarize() {
    if (!purpleCurrentPost) {
      addPurpleMessage('ä¸»äººï¼Œè¯·å…ˆæ‰“å¼€ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘å°±å¯ä»¥å¸®æ‚¨æ€»ç»“å•¦ï¼ğŸ’œ', 'assistant');
      return;
    }
    
    const title = purpleCurrentPost.title || 'è¿™ç¯‡æ–‡ç« ';
    const content = purpleCurrentPost.content || '';
    
    // ç®€å•çš„æœ¬åœ°æ€»ç»“ï¼ˆæå–å‰å‡ å¥ï¼‰
    const sentences = content.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim().length > 10);
    const summary = sentences.slice(0, 3).join('ã€‚');
    
    if (summary) {
      addPurpleMessage(`ğŸ“ <strong style="color: #D4AF37;">${title}</strong> çš„æ€»ç»“ï¼š<br><br>${summary}...<br><br>è¿™æ˜¯æ–‡ç« çš„æ ¸å¿ƒå†…å®¹~ âœ¨`, 'assistant');
    } else {
      addPurpleMessage(`ğŸ“ <strong style="color: #D4AF37;">${title}</strong><br><br>è¿™æ˜¯ä¸€ç¯‡ç²¾å½©çš„æ–‡ç« ~ å»ºè®®ä»”ç»†é˜…è¯»å…¨æ–‡å“¦ï¼ğŸ’œ`, 'assistant');
    }
  }
  
  // æ¨èæ–‡ç« 
  function handlePurpleRecommend() {
    if (purpleAllPosts.length === 0) {
      addPurpleMessage('ä¸»äººï¼Œæš‚æ—¶æ²¡æœ‰æ–‡ç« å¯ä»¥æ¨èå‘¢~ ç¨åå†æ¥å§ï¼ğŸ’œ', 'assistant');
      return;
    }
    
    // éšæœºé€‰æ‹©3ç¯‡æ–‡ç« 
    const shuffled = [...purpleAllPosts].sort(() => 0.5 - Math.random());
    const recommendations = shuffled.slice(0, 3);
    
    let reply = 'ğŸ“š ä¸ºæ‚¨æ¨èä»¥ä¸‹æ–‡ç« ï¼š<br><br>';
    recommendations.forEach((post, index) => {
      const shortTitle = post.title?.length > 20 ? post.title.substring(0, 20) + '...' : post.title;
      reply += `${index + 1}. <a href="/posts/${post.id}" style="color: #D4AF37; text-decoration: none; border-bottom: 1px solid #D4AF37;">${shortTitle}</a><br>`;
    });
    reply += '<br>ç‚¹å‡»æ ‡é¢˜å³å¯é˜…è¯»~ ğŸ’œ';
    
    addPurpleMessage(reply, 'assistant');
  }
  
  // æœç´¢æ–‡ç« 
  function handlePurpleSearch(keyword) {
    if (!keyword) {
      addPurpleMessage('ä¸»äººï¼Œè¯·è¾“å…¥æœç´¢å…³é”®è¯å“¦~ æ¯”å¦‚"æœç´¢ AI" ğŸ’œ', 'assistant');
      return;
    }
    
    if (purpleAllPosts.length === 0) {
      addPurpleMessage('ä¸»äººï¼Œæš‚æ—¶æ²¡æœ‰æ–‡ç« å¯ä»¥æœç´¢å‘¢~ ç¨åå†æ¥å§ï¼ğŸ’œ', 'assistant');
      return;
    }
    
    const results = purpleAllPosts.filter(post => {
      const title = post.title || '';
      const content = post.content || '';
      const tags = post.tags || [];
      const searchText = `${title} ${content} ${tags.join(' ')}`.toLowerCase();
      return searchText.includes(keyword.toLowerCase());
    });
    
    if (results.length === 0) {
      addPurpleMessage(`ğŸ” æ²¡æœ‰æ‰¾åˆ°åŒ…å«"${keyword}"çš„æ–‡ç« å‘¢~ æ¢ä¸ªå…³é”®è¯è¯•è¯•å§ï¼ğŸ’œ`, 'assistant');
    } else {
      let reply = `ğŸ” æ‰¾åˆ° ${results.length} ç¯‡å…³äº"<span style="color: #D4AF37;">${keyword}</span>"çš„æ–‡ç« ï¼š<br><br>`;
      results.slice(0, 5).forEach((post, index) => {
        const shortTitle = post.title?.length > 20 ? post.title.substring(0, 20) + '...' : post.title;
        reply += `${index + 1}. <a href="/posts/${post.id}" style="color: #D4AF37; text-decoration: none; border-bottom: 1px solid #D4AF37;">${shortTitle}</a><br>`;
      });
      if (results.length > 5) {
        reply += `<br>...è¿˜æœ‰ ${results.length - 5} ç¯‡ç›¸å…³æ–‡ç« ~ ğŸ’œ`;
      }
      addPurpleMessage(reply, 'assistant');
    }
  }
  
  // HTMLè½¬ä¹‰
  function escapePurpleHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
